name: Deploy Appcast

on:
  release:
    types: [published]

permissions:
  contents: write

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: false

env:
  SPARKLE_VERSION: "2.8.1"

jobs:
  deploy:
    name: Generate & Deploy Appcast
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Sparkle tools
        run: |
          mkdir -p sparkle-tools
          curl -sL "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz" \
            | tar -xJ -C sparkle-tools --include='./bin/*'

      - name: Download release zip
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p staging
          gh release download "${{ github.event.release.tag_name }}" \
            --pattern '*.zip' \
            --dir staging

      - name: Fetch existing appcast from gh-pages
        continue-on-error: true
        run: |
          git fetch origin gh-pages --depth=1 || true
          git show origin/gh-pages:appcast.xml > staging/appcast.xml 2>/dev/null || true

      - name: Generate appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key
          sparkle-tools/bin/generate_appcast \
            --ed-key-file /tmp/sparkle_key \
            --download-url-prefix "https://github.com/lennondotw/Speakable/releases/download/${{ github.event.release.tag_name }}/" \
            staging
          rm -f /tmp/sparkle_key

      - name: Deploy to gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create orphan gh-pages branch or check it out
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . || true
          fi

          # Copy generated content
          cp staging/appcast.xml .
          cp docs/index.html . 2>/dev/null || true

          echo "Pages content:"
          ls -la appcast.xml index.html

          # Commit and push
          git add appcast.xml index.html
          git diff --cached --quiet && echo "No changes to deploy" && exit 0
          git commit -m "Update appcast for ${{ github.event.release.tag_name }}"
          git push origin gh-pages
